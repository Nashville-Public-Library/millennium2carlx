<?php
// format_bibliographic.php
// James Staub
// Nashville Public Library
// Update MARC records exported from Millennium
// to meet CARL.X import requirements

// 20170609 : version 1
//	exclude a list of Millennium records by record number
//	exclude Nashville Public Library Obituary records

ini_set('memory_limit', '1024M');
require_once 'File/MARC.php';
date_default_timezone_set('America/Chicago');

$bibliographicFileInput = "../data/millennium_extract-07.mrc";
$bibliographicFileOutput = fopen('../data/BIBLIOGRAPHIC.mrc','wb');
$bibliographicRecords = new File_MARC($bibliographicFileInput);

$exclude = array(".b19009677",
".b19479128",
".b19497866",
".b19535806",
".b19535892",
".b1953632x",
".b19536859",
".b19570582",
".b19570727",
".b19571938",
".b19572608",
".b19580861",
".b19580873",
".b19580885",
".b19580940",
".b19597216",
".b19597393",
".b1959768x",
".b19600458",
".b19603460",
".b19603472",
".b19628365",
".b19697594",
".b19708130",
".b1973587x",
".b19746258",
".b19746325",
".b19756112",
".b19756690",
".b19799950",
".b19819493",
".b19825316",
".b19861497",
".b19868583",
".b19868984",
".b19880753",
".b19881253",
".b1988512x",
".b19885246",
".b19888764",
".b19888867",
".b19888909",
".b19892445",
".b19892500",
".b19895677",
".b19895707",
".b19895719",
".b19895720",
".b19902700",
".b19905774",
".b19906882",
".b19906894",
".b19914258",
".b19915135",
".b19917119",
".b19917144",
".b19917156",
".b19918392",
".b19918410",
".b19918458",
".b1991846x",
".b19919165",
".b19919177",
".b19919189",
".b19919190",
".b19919232",
".b19919992",
".b19923181",
".b1992401x",
".b19932704",
".b1993466x",
".b19934774",
".b19937465",
".b19939279",
".b19939309",
".b19940804",
".b19941201",
".b19942370",
".b19944445",
".b1995623x",
".b19956599",
".b1995900x",
".b19959059",
".b19972015",
".b19972362",
".b19981272",
".b19982203",
".b19982574",
".b19982781",
".b19987390",
".b19996731",
".b2000994x",
".b2001286x",
".b20023194",
".b20028143",
".b20036061",
".b20036139",
".b20062606",
".b20062795",
".b20065176",
".b20065346",
".b20068864",
".b20072703",
".b20072764",
".b20074608",
".b20076435",
".b20084195",
".b20089612",
".b20094620",
".b20098522",
".b20098534",
".b20100188",
".b20107122",
".b20107171",
".b20107183",
".b20107237",
".b20107328",
".b2010733x",
".b20107390",
".b20107407",
".b20107493",
".b2010750x",
".b20107602",
".b2010764x",
".b20107675",
".b2011140x",
".b20111770",
".b20119392",
".b20119525",
".b20119707",
".b20126918",
".b20134538",
".b20134836",
".b2013633x",
".b20147508",
".b2014751x",
".b20154598",
".b20154604",
".b20163241",
".b20166679",
".b20170105",
".b20200468",
".b20209708",
".b2021375x",
".b20216191",
".b20220169",
".b20247904",
".b20256759",
".b20259414",
".b20259724",
".b20268725",
".b20279887",
".b20291577",
".b20291917",
".b20295388",
".b20296095",
".b20296290",
".b20297026",
".b20339665",
".b20341647",
".b20345148",
".b20397434",
".b20427165",
".b20427177",
".b20446299",
".b20473138",
".b20485608",
".b2048561x",
".b20485621",
".b20485633",
".b20485657",
".b20485669",
".b20485670",
".b20485682",
".b20485694",
".b20485700",
".b20485712",
".b20485724",
".b20485736",
".b20490719",
".b20493496",
".b20496035",
".b20496047",
".b20496096",
".b20517907",
".b20522344",
".b20549982",
".b20550030",
".b20550212",
".b20562081",
".b20566864",
".b20593211",
".b20593636",
".b20599717",
".b20599900",
".b20599912",
".b20667048",
".b20688477",
".b20724895",
".b20725292",
".b20725322",
".b20726624",
".b20929018",
".b22647934",
".b22750071",
".b2282179x",
".b2288063x",
".b22891122",
".b22891456",
".b22891614",
".b22942075",
".b23106463",
".b23249183",
".b2329629x",
".b23327339",
".b2334622x",
".b23352279",
".b23356571",
".b23399788",
".b23412550",
".b23416543",
".b23416713",
".b23448179",
".b23471062",
".b23481547",
".b23485541",
".b23545604"
);

$count=0;
$countExcluded=0;
while ($bibliographicRecord = $bibliographicRecords->next()) {
	$count++;
#EXCLUDE BY MILLENNIUM RECORD NUMBER IN EXCLUDE ARRAY
	if (in_array(trim($bibliographicRecord->getField('907')->getSubfield('a')->getData()),$exclude)) { 
		$countExcluded++;
//print "-";
		continue;
	} 
#EXCLUDE OBITUARIES
	if ($bibliographicRecord->getField('998')->getSubfield('e')) {
		if (trim($bibliographicRecord->getField('998')->getSubfield('e')->getData())=='d') { 
			$countExcluded++;
//print "-";
			continue;
		} 
	}
//print ".";
	fwrite($bibliographicFileOutput, $bibliographicRecord->toRaw());
}
//print "total input records: $count\nexcluded: $countExcluded\n";
fclose($bibliographicFileOutput);
?>
